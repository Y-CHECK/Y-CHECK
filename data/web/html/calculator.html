<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Y-CHECK · 계산기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-[#f7f9fc] text-slate-900 pb-24">

<!-- HEADER -->
<header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="../img/ycheck_logo.png" class="h-8" alt="Y-CHECK 로고">
            <div class="h-4 w-px bg-slate-200"></div>
            <div class="text-sm text-slate-600">연세대학교 졸업요건계산기</div>
        </div>
        <nav class="hidden sm:flex items-center gap-6 text-sm text-slate-600">
            <a href="calculator.html" class="hover:text-slate-900 font-semibold">계산기</a>
            <a href="timetable.html" class="hover:text-slate-900">시간표</a>
            <a href="sunbae.html" class="hover:text-slate-900">선배들의 발자취</a>
            <a href="mypage.html" class="hover:text-slate-900">마이페이지</a>
        </nav>
    </div>
</header>

<!-- MAIN -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- LEFT PANEL -->
    <section class="lg:col-span-4 space-y-4">
        <div class="bg-white rounded-2xl border shadow-sm p-5">

            <!-- 내 정보 -->
            <h2 class="text-lg font-semibold mb-4 border-b pb-2">내 정보</h2>

            <label class="block text-sm text-slate-600 mb-1">입학년도</label>
            <select id="entryYear" class="w-full rounded-xl border px-3 py-2 text-sm mb-3">
                <option value="2022">2022 학번</option>
            </select>

            <label class="block text-sm text-slate-600 mb-1">전공</label>
            <select id="major" class="w-full rounded-xl border px-3 py-2 text-sm mb-3">
                <option value="소프트웨어학부">소프트웨어학부</option>
            </select>

            <!-- 트랙 선택 -->
            <div class="mb-3">
                <div class="text-sm text-slate-600 mb-1">트랙</div>
                <div class="space-y-1 text-sm">
                    <label class="mr-4">
                        <input type="radio" name="track" value="none" checked> 미정
                    </label>
                    <br class="sm:hidden" />
                    <label class="mr-4">
                        <input type="radio" name="track" value="ai_bigdata"> AI·빅데이터
                    </label>
                    <label class="mr-4">
                        <input type="radio" name="track" value="ai_media"> AI미디어
                    </label>
                    <label class="mr-4">
                        <input type="radio" name="track" value="ai_science"> AI계산과학
                    </label>
                    <label class="mr-4">
                        <input type="radio" name="track" value="smart_iot"> 스마트IoT
                    </label>
                    <label class="mr-4">
                        <input type="radio" name="track" value="security"> 정보보안
                    </label>
                </div>
            </div>

            <!-- 과목 필터 -->
            <div class="border rounded-xl p-3 mb-3">
                <div class="font-semibold text-sm mb-2">과목 필터</div>

                <select id="filterCategory" class="w-full rounded-xl border px-3 py-2 text-sm mb-2">
                    <option value="ALL">전체보기</option>
                    <option value="1000">1000단위</option>
                    <option value="2000">2000단위</option>
                    <option value="3000">3000단위</option>
                    <option value="4000">4000단위</option>

                    <option value="GE_BASIC">교양기초</option>
                    <option value="GE_UNIV_REQUIRED">대학교양필수</option>

                    <!-- 영역별 -->
                    <option value="GE_UNIV_ELECTIVE_1">1영역</option>
                    <option value="GE_UNIV_ELECTIVE_2">2영역</option>
                    <option value="GE_UNIV_ELECTIVE_3">3영역</option>
                    <option value="GE_UNIV_ELECTIVE_4">4영역</option>
                    <option value="GE_UNIV_ELECTIVE_5">5영역</option>
                    <option value="GE_UNIV_ELECTIVE_6">6영역</option>
                    <option value="GE_UNIV_ELECTIVE_9">9영역</option>

                    <option value="EXPLORATION">전공탐색</option>
                    <option value="MAJOR_BASIC">기본전공</option>
                    <option value="MAJOR_DEEP">심화전공</option>
                </select>

                <input
                        id="searchInput"
                        placeholder="과목명/코드 검색"
                        class="w-full rounded-xl border px-3 py-2 text-sm mb-2"
                >

                <button
                        onclick="applyFilter()"
                        class="w-full bg-slate-700 text-white py-2 rounded-xl text-sm font-semibold"
                >
                    필터 적용
                </button>
            </div>

            <!-- 과목 목록 (스크롤) -->
            <div class="border rounded-xl p-3">
                <div class="text-sm font-semibold mb-2">이수 과목 선택</div>
                <div
                        id="courseList"
                        class="space-y-1 text-sm text-slate-700 max-h-[360px] overflow-y-auto pr-1"
                ></div>
            </div>

            <button
                    onclick="calculate()"
                    class="w-full mt-4 py-2 bg-blue-600 text-white rounded-xl text-sm font-semibold"
            >
                졸업요건 계산하기
            </button>

        </div>
    </section>

    <!-- RIGHT PANEL -->
    <section class="lg:col-span-8 space-y-4">

        <!-- 요약 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white rounded-2xl border shadow-sm p-5 text-center">
                <div class="text-sm text-slate-500">누적 이수 학점</div>
                <div id="summaryTotalCredits" class="mt-2 text-3xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-white rounded-2xl border shadow-sm p-5 text-center">
                <div class="text-sm text-slate-500">필요 학점</div>
                <div id="summaryRequiredCredits" class="mt-2 text-3xl font-bold text-slate-800">135</div>
            </div>
            <div class="bg-white rounded-2xl border shadow-sm p-5 text-center">
                <div class="text-sm text-slate-500">졸업 가능 여부</div>
                <div id="summaryCanGraduate" class="mt-2 text-3xl font-bold text-rose-500">-</div>
            </div>
        </div>

        <!-- 진행률 -->
        <div class="bg-white rounded-2xl border shadow-sm p-5">
            <h3 class="text-sm text-slate-500 mb-3">졸업요건 영역별 진행률</h3>
            <div id="progressList" class="space-y-4"></div>
        </div>

        <!-- 대학교양 영역 이수 현황 -->
        <div id="areaStatusCard" class="bg-white rounded-2xl border shadow-sm p-5">
            <h3 class="text-sm text-slate-500 mb-3">대학교양 선택 영역 이수 현황</h3>
            <div id="areaStatusContent" class="text-sm">
                <!-- JS에서 채움 -->
            </div>
        </div>

    </section>
</main>

<!-- ================================
     JS
================================= -->
<script>
    const STORAGE_KEY = "ycheck_selected_courses_2022_swe";

    let allCourses = [];
    let currentFiltered = [];
    let selectedCourses = new Set();

    /* ============================
       0) 선택 과목 localStorage 저장/로드
    ============================ */
    function loadSelectionFromStorage() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const arr = JSON.parse(raw);
            if (Array.isArray(arr)) {
                selectedCourses = new Set(arr);
            }
        } catch (e) {
            console.warn("선택 과목 로드 실패", e);
        }
    }

    function saveSelectionToStorage() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify([...selectedCourses]));
        } catch (e) {
            console.warn("선택 과목 저장 실패", e);
        }
    }

    /* ============================
       1) 과목 로딩
    ============================ */
    async function loadCourses() {
        const res = await fetch("http://localhost:8000/api/curriculum/courses/");
        allCourses = await res.json();
        currentFiltered = [...allCourses];
        renderCourseList();
    }

    /* ============================
       2) 과목 리스트 렌더링
    ============================ */
    function renderCourseList() {
        const list = document.getElementById("courseList");
        list.innerHTML = "";

        currentFiltered.forEach(c => {
            list.innerHTML += `
        <label class="block">
          <input type="checkbox"
            class="mr-2 course-checkbox"
            value="${c.code}"
            ${selectedCourses.has(c.code) ? "checked" : ""}>
          ${c.code} - ${c.name} (${c.credits}학점)
        </label>
      `;
        });

        document.querySelectorAll(".course-checkbox").forEach(cb => {
            cb.addEventListener("change", () => {
                if (cb.checked) {
                    selectedCourses.add(cb.value);
                } else {
                    selectedCourses.delete(cb.value);
                }
                saveSelectionToStorage();   // ✅ 변경될 때마다 저장
            });
        });
    }

    /* ============================
       3) 필터 적용
    ============================ */
    function applyFilter() {
        const filter = document.getElementById("filterCategory").value;
        const search = document.getElementById("searchInput").value.trim().toLowerCase();

        currentFiltered = allCourses.filter(c => {
            let ok = true;

            if (["1000","2000","3000","4000"].includes(filter)) {
                ok = String(c.level).startsWith(filter);
            } else if (filter !== "ALL") {
                ok = c.category === filter;
            }

            if (search) {
                const key = (c.code + c.name).toLowerCase();
                ok = ok && key.includes(search);
            }

            return ok;
        });

        renderCourseList();
    }

    /* ============================
       4) 졸업요건 계산
    ============================ */
    async function calculate() {
        const selectedList = allCourses.filter(c => selectedCourses.has(c.code));

        let totalCredits = 0;
        const credits = {
            GE_BASIC: 0,
            GE_UNIV_REQUIRED: 0,
            EXPLORATION: 0,
            MAJOR_BASIC: 0,
            MAJOR_DEEP: 0,
            LEVEL300: 0
        };

        selectedList.forEach(c => {
            const credit = Number(c.credits);
            totalCredits += credit;

            if (credits[c.category] !== undefined)
                credits[c.category] += credit;

            if (c.level >= 3000)
                credits["LEVEL300"] += credit;
        });

        const payload = {
            entry_year: 2022,
            major: "소프트웨어학부",
            track: document.querySelector("input[name='track']:checked").value,
            total_credits: totalCredits,
            completed_courses: [...selectedCourses],
            credits: {
                liberal_basic: credits.GE_BASIC,
                univ_required: credits.GE_UNIV_REQUIRED,
                exploration: credits.EXPLORATION,
                major_basic: credits.MAJOR_BASIC,
                deep_major: credits.MAJOR_DEEP,
                level300: credits.LEVEL300,
                track: 15  // TODO: 실제 트랙 학점 계산 로직 넣을 수 있음
            },
            flags: {
                second_major_done: true,
                language_cert: true,
                it_cert: true,
                industry_cert: false
            }
        };

        const res = await fetch("http://localhost:8000/api/curriculum/calculate/", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        document.getElementById("summaryTotalCredits").innerText = totalCredits;
        document.getElementById("summaryRequiredCredits").innerText = data.summary.required_total_credits;
        document.getElementById("summaryCanGraduate").innerText =
            data.summary.can_graduate ? "가능" : "불가";

        renderProgress(credits, data.major_required.percentage);
        renderAreaStatus(selectedList);
    }

    /* ============================
       5) 진행률 바
    ============================ */
    function renderProgress(credits, majorPercent) {
        const NEEDED = {
            GE_BASIC: 22,
            GE_UNIV_REQUIRED: 5,
            EXPLORATION: 21,
            MAJOR_BASIC: 36,
            MAJOR_DEEP: 36,
            LEVEL300: 45
        };

        const NAMES = {
            GE_BASIC: "교양기초",
            GE_UNIV_REQUIRED: "대학교양필수",
            EXPLORATION: "전공탐색",
            MAJOR_BASIC: "기본전공",
            MAJOR_DEEP: "심화전공",
            LEVEL300: "3000단위 이상"
        };

        let html = "";

        Object.keys(NEEDED).forEach(k => {
            const now = credits[k] || 0;
            const min = NEEDED[k];
            const pct = Math.min(100, Math.round((now / min) * 100));

            html += `
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span>${NAMES[k]}</span>
            <span>${pct}% (${now}/${min})</span>
          </div>
          <div class="h-2 bg-slate-100 rounded-full">
            <div class="h-full bg-blue-500" style="width:${pct}%"></div>
          </div>
        </div>
      `;
        });

        html += `
      <div>
        <div class="flex justify-between text-xs mb-1">
          <span>전공필수</span>
          <span>${majorPercent}%</span>
        </div>
        <div class="h-2 bg-slate-100 rounded-full">
          <div class="h-full bg-blue-500" style="width:${majorPercent}%"></div>
        </div>
      </div>
    `;

        document.getElementById("progressList").innerHTML = html;
    }

    /* ============================
       6) 영역 이수 현황
    ============================ */
    function getAreaFromCourse(course) {
        // 1) DB에서 ge_area 내려오는 경우 우선 사용
        if (course.ge_area) return course.ge_area;

        // 2) category 기반으로 직접 판별
        switch (course.category) {
            case "GE_UNIV_ELECTIVE_1": return "1영역";
            case "GE_UNIV_ELECTIVE_2": return "2영역";
            case "GE_UNIV_ELECTIVE_3": return "3영역";
            case "GE_UNIV_ELECTIVE_4": return "4영역";
            case "GE_UNIV_ELECTIVE_5": return "5영역";
            case "GE_UNIV_ELECTIVE_6": return "6영역";
            case "GE_UNIV_ELECTIVE_9": return "9영역";
            default: return null;
        }
    }

    function renderAreaStatus(selectedList) {
        const set = new Set();

        selectedList.forEach(c => {
            const area = getAreaFromCourse(c);
            if (area) set.add(area);
        });

        const count = set.size;
        const required = 5;
        const ok = count >= required;

        let html = `
      <div class="flex justify-between mb-2">
        <span>이수한 영역 수</span>
        <span class="${ok ? "text-green-600" : "text-rose-600"} font-semibold">
          ${count}개 / ${required}개 (${ok ? "충족" : "미충족"})
        </span>
      </div>

      <div class="flex flex-wrap gap-2 mt-2">
    `;

        [...set].forEach(a => {
            html += `
        <span class="px-3 py-1 text-xs rounded-full bg-blue-50 border border-blue-200 text-blue-700">
          ${a}
        </span>
      `;
        });

        html += `</div>`;
        document.getElementById("areaStatusContent").innerHTML = html;
    }

    /* ============================
       7) 페이지 로드 시 초기화
    ============================ */
    window.onload = async () => {
        loadSelectionFromStorage();  // ✅ 선택했던 과목 복원
        await loadCourses();         // 과목 로딩 후 체크박스 반영
    };
</script>

</body>
</html>
