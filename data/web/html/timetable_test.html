<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Y_CHECK 시간표 (API 연동 테스트)</title>
    <style>
        body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          background: #f5f7fb;
          padding: 24px;
        }
        h1 {
          font-size: 26px;
          font-weight: 700;
          margin-bottom: 16px;
        }
        .top-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }
        .semester-label {
          font-size: 18px;
          font-weight: 600;
        }
        .muted {
          font-size: 13px;
          color: #6b7280;
        }
        .card {
          background: #fff;
          border-radius: 14px;
          padding: 16px 20px;
          box-shadow: 0 2px 4px rgba(15,23,42,0.06);
          margin-bottom: 16px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          font-size: 14px;
        }
        th, td {
          border-bottom: 1px solid #e5e7eb;
          padding: 8px 6px;
          text-align: center;
        }
        th {
          background: #f9fafb;
          font-weight: 600;
        }
        td.time-label {
          font-weight: 600;
          background: #f9fafb;
          width: 70px;
        }
        td.slot {
          min-height: 40px;
        }
        .subject-pill {
          display: inline-flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 4px 6px;
          border-radius: 8px;
          background: #eff6ff;
          color: #1d4ed8;
          font-size: 12px;
          line-height: 1.2;
          min-width: 80px;
        }
        .subject-code {
          font-weight: 500;
        }
        .subject-title {
          margin-top: 2px;
          white-space: nowrap;
        }
        button {
          border-radius: 999px;
          border: 1px solid #e5e7eb;
          padding: 6px 12px;
          background: #2563eb;
          color: #fff;
          font-size: 13px;
          cursor: pointer;
        }
        button.secondary {
          background: #fff;
          color: #111827;
        }
    </style>
</head>
<body>
<h1>Y_CHECK 시간표 (API 연동 테스트)</h1>

<div class="top-bar">
    <div>
        <div class="semester-label" id="semester-label">학기 정보 없음</div>
        <div class="muted" id="semester-sub">/api/timetable/current/ 에서 이번 학기 정보를 불러옵니다.</div>
    </div>
    <div>
        <button id="reload-btn">이번 학기 시간표 불러오기</button>
    </div>
</div>

<div class="card">
    <table id="timetable-table">
        <!-- JS에서 채움 -->
    </table>
</div>

<script>
    // 영문 요일을 표에 보여줄 한글 라벨로 매핑
    const DAY_LABELS = {
      "Mon": "월",
      "Tue": "화",
      "Wed": "수",
      "Thu": "목",
      "Fri": "금",
      "Sat": "토",
      "Sun": "일",
    };

    // 요일 정렬 순서
    const DAY_ORDER = ["Mon", "Tue", "Wed", "Thu", "Fri"];

    async function loadCurrentTimetable() {
      const btn = document.getElementById("reload-btn");
      btn.textContent = "불러오는 중...";
      btn.disabled = true;

      try {
        const res = await fetch("/api/timetable/current/");
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        // 기본 구조 안전하게 꺼내기
        const year = data.year ?? "-";
        const sem = data.semester ?? "-";
        const grid = Array.isArray(data.grid) ? data.grid : [];

        document.getElementById("semester-label").textContent =
          `${year}년 ${sem}`;
        document.getElementById("semester-sub").textContent =
          "아래 시간표는 /api/timetable/current/ 응답을 그대로 표현한 것입니다.";

        // day -> slots 맵으로 정리
        const dayMap = {};
        grid.forEach(d => {
          const dayKey = d.day;
          const slots = Array.isArray(d.slots) ? d.slots : [];
          dayMap[dayKey] = slots;
        });

        // 등장한 모든 교시 모으기 (중복 제거 후 정렬)
        const periodSet = new Set();
        Object.values(dayMap).forEach(slots => {
          slots.forEach(s => {
            if (typeof s.period === "number") {
              periodSet.add(s.period);
            }
          });
        });
        const periods = Array.from(periodSet).sort((a, b) => a - b);

        buildTimetableTable(dayMap, periods);
      } catch (err) {
        alert("시간표 API 호출 중 오류: " + err);
        buildTimetableTable({}, []); // 비워진 표
      } finally {
        btn.textContent = "이번 학기 시간표 다시 불러오기";
        btn.disabled = false;
      }
    }

    function buildTimetableTable(dayMap, periods) {
      const table = document.getElementById("timetable-table");
      table.innerHTML = "";

      // 헤더
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      const thTime = document.createElement("th");
      thTime.textContent = "교시";
      headerRow.appendChild(thTime);

      DAY_ORDER.forEach(dayKey => {
        const th = document.createElement("th");
        th.textContent = DAY_LABELS[dayKey] || dayKey;
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      // 바디
      const tbody = document.createElement("tbody");

      if (periods.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = DAY_ORDER.length + 1;
        td.textContent = "시간표 데이터가 없습니다.";
        td.style.padding = "16px";
        tbody.appendChild(tr);
        tr.appendChild(td);
        table.appendChild(tbody);
        return;
      }

      periods.forEach(p => {
        const tr = document.createElement("tr");

        const timeTd = document.createElement("td");
        timeTd.className = "time-label";
        timeTd.textContent = `${p}교시`;
        tr.appendChild(timeTd);

        DAY_ORDER.forEach(dayKey => {
          const td = document.createElement("td");
          td.className = "slot";
          const slots = dayMap[dayKey] || [];
          const slot = slots.find(s => s.period === p);

          if (slot) {
            const pill = document.createElement("div");
            pill.className = "subject-pill";

            const codeSpan = document.createElement("span");
            codeSpan.className = "subject-code";
            codeSpan.textContent = slot.code || "";

            const titleSpan = document.createElement("span");
            titleSpan.className = "subject-title";
            titleSpan.textContent = slot.title || "";

            pill.appendChild(codeSpan);
            pill.appendChild(titleSpan);
            td.appendChild(pill);
          } else {
            td.textContent = "";  // 빈 칸
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
    }

    document.getElementById("reload-btn").addEventListener("click", loadCurrentTimetable);
    // 페이지 진입 시 한 번 자동 호출
    loadCurrentTimetable();
</script>
</body>
</html>
