<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Y-CHECK · 메인</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print{.no-print{display:none!important}}
  </style>
</head>

<body class="min-h-screen bg-[#f7f9fc] text-slate-900 pb-24">

  <!-- HEADER -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="main.html" class="flex items-center gap-3">
          <img src="../img/ycheck_logo.png" alt="Y-CHECK 로고" class="h-8 w-auto">
        </a>
        <div class="h-4 w-px bg-slate-200"></div>
        <div class="text-sm text-slate-600">연세대학교 졸업요건계산기</div>
      </div>
      <nav class="hidden sm:flex items-center gap-6 text-sm text-slate-600">
        <a href="calculator.html" class="hover:text-slate-900">계산기</a>
        <a href="timetable.html" class="hover:text-slate-900">시간표</a>
        <a href="sunbae.html" class="hover:text-slate-900">선배들의 발자취</a>
        <a href="mypage.html" class="hover:text-slate-900">마이페이지</a>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- LEFT -->
    <section class="lg:col-span-9 space-y-6">

      <!-- 총 이수 진행도 -->
      <div class="bg-white rounded-2xl border shadow-sm p-6 h-40 flex flex-col justify-between">
        <div>
          <div class="text-sm text-slate-500">총 이수 진행도</div>
          <div id="total-progress-text" class="mt-1 text-4xl font-extrabold tracking-tight">0 / 0 점</div>
        </div>
        <div class="mt-4 flex items-center gap-3">
          <div class="flex-1 h-3 bg-slate-100 rounded-full overflow-hidden">
            <div id="total-progress-bar" class="h-full bg-gradient-to-r from-blue-200 via-blue-500 to-blue-800" style="width:0%"></div>
          </div>
          <div id="total-progress-percent" class="w-16 text-right text-lg font-bold text-emerald-600">0%</div>
        </div>
      </div>

      <!-- 이수학점 (분류별) -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- 성적 비율 (임시 그래프 그대로 유지) -->
        <div class="bg-white rounded-2xl border shadow-sm p-5">
          <div class="text-sm text-slate-500 mb-3">성적 비율</div>
          <div class="grid grid-cols-2 gap-4 items-center">
            <div class="flex justify-center">
              <svg viewBox="0 0 120 120" class="w-32 h-32">
                <circle cx="60" cy="60" r="40" fill="none" stroke="#e5edff" stroke-width="16" />
                <circle cx="60" cy="60" r="40" fill="none" stroke="#2563eb" stroke-width="16"
                  stroke-linecap="round" stroke-dasharray="118 999" stroke-dashoffset="-90"
                  transform="rotate(-90 60 60)" />
                <circle cx="60" cy="60" r="40" fill="none" stroke="#f43f5e" stroke-width="16"
                  stroke-linecap="round" stroke-dasharray="111 999" stroke-dashoffset="-208"
                  transform="rotate(-90 60 60)" />
                <circle cx="60" cy="60" r="40" fill="none" stroke="#f59e0b" stroke-width="16"
                  stroke-linecap="round" stroke-dasharray="18 999" stroke-dashoffset="-319"
                  transform="rotate(-90 60 60)" />
                <circle cx="60" cy="60" r="24" fill="white" />
              </svg>
            </div>
            <ul class="text-sm space-y-1">
              <li class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:#2563eb"></span><span>A+~A0</span><span class="ml-auto text-slate-500">47%</span></li>
              <li class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:#f43f5e"></span><span>B+~B0</span><span class="ml-auto text-slate-500">44%</span></li>
              <li class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:#f59e0b"></span><span>C+~C0</span><span class="ml-auto text-slate-500">7%</span></li>
              <li class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:#10b981"></span><span>D+~D0</span><span class="ml-auto text-slate-500">0%</span></li>
              <li class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:#64748b"></span><span>F</span><span class="ml-auto text-slate-500">0%</span></li>
            </ul>
          </div>
        </div>

        <!-- 이수학점 (분류별) -->
        <div class="bg-white rounded-2xl border shadow-sm p-5 lg:col-span-2">
          <div class="text-sm text-slate-500 mb-3">이수 학점 (분류별)</div>

          <div class="mb-4">
            <div class="flex justify-between text-sm"><span class="font-medium">교양</span><span id="ge-basic-text">0 / 0</span></div>
            <div class="flex items-center gap-3 mt-2">
              <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                <div id="ge-basic-bar" class="h-full bg-gradient-to-r from-blue-200 via-blue-500 to-blue-800" style="width:0%"></div>
              </div>
              <div id="ge-basic-percent" class="w-10 text-right text-xs font-semibold">0%</div>
            </div>
          </div>

          <div class="mb-4">
            <div class="flex justify-between text-sm"><span class="font-medium">전공필수</span><span id="major-basic-text">0 / 0</span></div>
            <div class="flex items-center gap-3 mt-2">
              <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                <div id="major-basic-bar" class="h-full bg-gradient-to-r from-blue-200 via-blue-500 to-blue-800" style="width:0%"></div>
              </div>
              <div id="major-basic-percent" class="w-10 text-right text-xs font-semibold">0%</div>
            </div>
          </div>

          <div>
            <div class="flex justify-between text-sm"><span class="font-medium">전공선택</span><span id="major-deep-text">0 / 0</span></div>
            <div class="flex items-center gap-3 mt-2">
              <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                <div id="major-deep-bar" class="h-full bg-gradient-to-r from-blue-200 via-blue-500 to-blue-800" style="width:0%"></div>
              </div>
              <div id="major-deep-percent" class="w-10 text-right text-xs font-semibold">0%</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 수강 과목 리스트 -->
      <div class="bg-white rounded-2xl border shadow-sm p-5">
        <div class="text-sm text-slate-500">수강 과목 리스트</div>
        <div class="overflow-x-auto mt-3">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500 border-b">
                <th class="py-2 pr-4">과목명</th>
                <th class="py-2 pr-4">분류</th>
                <th class="py-2 pr-4">학점</th>
              </tr>
            </thead>
            <tbody id="course-list-body">
              <!-- JS로 자동 삽입 -->
            </tbody>
          </table>
        </div>
      </div>

    </section>

    <!-- RIGHT -->
    <aside class="lg:col-span-3 flex flex-col space-y-6">

      <!-- 프로필 -->
      <div class="bg-white rounded-2xl border shadow-sm p-5 h-40 flex flex-col justify-between">
        <div class="text-right text-xs text-slate-400">베타</div>
        <div>
          <div id="profile-name" class="text-lg font-semibold">로그인 필요</div>
          <div id="profile-semester" class="text-sm text-slate-600">-/ -</div>
          <div id="profile-major" class="text-sm text-slate-600"></div>
        </div>
      </div>

      <!-- 시간표 (기존 유지) -->
      <div class="bg-white rounded-2xl border shadow-sm p-5 min-h-[420px]">
        <div class="text-sm text-slate-500 mb-3">시간표</div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-center border-collapse">
            <thead>
              <tr class="text-slate-600">
                <th class="w-16 py-2 border"></th>
                <th class="py-2 border">월</th>
                <th class="py-2 border">화</th>
                <th class="py-2 border">수</th>
                <th class="py-2 border">목</th>
                <th class="py-2 border">금</th>
              </tr>
            </thead>
            <tbody>
              <!-- 9~5 시간표 -->
              ${[...Array(9)].map((_, i) => `
                <tr>
                  <td class="py-2 border text-slate-500">${i+9}</td>
                  <td class="h-10 border"></td>
                  <td class="h-10 border"></td>
                  <td class="h-10 border"></td>
                  <td class="h-10 border"></td>
                  <td class="h-10 border"></td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>

      <!-- 채플 -->
      <div class="bg-white rounded-2xl border shadow-sm p-5">
        <div class="text-sm text-slate-500 mb-3">채플 카운트</div>
        <div class="flex items-center gap-2">
          <input id="chapel-input" type="number" min="0" max="4" value="0"
            class="w-20 px-3 py-2 rounded-xl border text-sm text-center"/>
          <span class="text-slate-500 text-sm">/ 4</span>
          <span id="chapel-percent" class="ml-auto text-sm font-semibold text-emerald-600">0%</span>
        </div>
        <div class="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden">
          <div id="chapel-bar"
            class="h-full bg-gradient-to-r from-blue-200 via-blue-500 to-blue-800"
            style="width:0%"></div>
        </div>
      </div>

      <!-- 메모 -->
      <div class="bg-white rounded-2xl border shadow-sm p-5">
        <div class="text-sm text-slate-500 mb-2">졸업 요구사항 (메모)</div>
        <textarea id="memo-text" class="w-full h-40 rounded-2xl border px-3 py-2 text-sm resize-none"
          placeholder="- 졸업작품 / 졸업논문 중 택1&#10;- 토익 800+"></textarea>
      </div>

    </aside>
  </main>

  <!-- FOOTER -->
  <footer class="fixed bottom-0 inset-x-0 bg-white border-t">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-start justify-between">
      <div class="flex items-start gap-4">
        <img src="../img/ycheck_logo.png" class="h-6" />
        <div class="space-y-1 text-sm text-slate-600">
          <div>강원특별자치도 원주시 흥업면 연세대길 1 창조관</div>
          <div>TEL) 033-123-4567</div>
          <div>EMAIL: YCHECK@gmail.com</div>
        </div>
      </div>
      <div class="flex items-center gap-6 text-sm text-slate-600">
        <span class="hidden sm:block h-6 w-px bg-slate-200"></span>
        <span>만든이들</span>
        <span>문의하기</span>
      </div>
    </div>
  </footer>

  <!-- ============================= -->
  <!--         JS SECTION            -->
  <!-- ============================= -->
  <script>
    async function loadProfile() {
      try {
        const resp = await fetch("/api/login-status/", { method: "GET", credentials: "include" });
        if (!resp.ok) return;

        const data = await resp.json();
        if (!data.logged_in) return;

        const p = data.profile;
        document.getElementById("profile-name").textContent = p.real_name + "님";
        document.getElementById("profile-semester").textContent = p.student_id + " / " + (p.current_semester || "-");
        document.getElementById("profile-major").textContent = p.major_department;
      } catch (e) { console.error(e); }
    }


    async function loadCreditSummary() {
      try {
        const resp = await fetch("/api/curriculum/credit-summary/", {
          method: "GET",
          credentials: "include",
        });

        if (!resp.ok) return;

        const s = await resp.json();

        // 총 학점 progress
        const requiredTotal = 133; // 필요 총 학점(정책적으로 고정)
        const pct = Math.min(100, Math.round((s.total_credits / requiredTotal) * 100));

        document.getElementById("total-progress-text").textContent = `${s.total_credits} / ${requiredTotal} 점`;
        document.getElementById("total-progress-bar").style.width = pct + "%";
        document.getElementById("total-progress-percent").textContent = pct + "%";

        // 교양 / 전필 / 전선
        updateCategory("ge-basic", s.GE_BASIC, 52);
        updateCategory("major-basic", s.MAJOR_BASIC, 65);
        updateCategory("major-deep", s.MAJOR_DEEP, 16);

      } catch (e) { console.error(e); }
    }

    function updateCategory(prefix, earned, required) {
      const pct = Math.round((earned / required) * 100);
      document.getElementById(`${prefix}-text`).textContent = `${earned} / ${required}`;
      document.getElementById(`${prefix}-bar`).style.width = pct + "%";
      document.getElementById(`${prefix}-percent`).textContent = pct + "%";
    }

    async function loadCourseList() {
      try {
        const resp = await fetch("/api/curriculum/taken-courses/", {
          method: "GET",
          credentials: "include",
        });

        if (!resp.ok) return;

        const courses = await resp.json();
        const tbody = document.getElementById("course-list-body");
        tbody.innerHTML = "";

        courses.forEach(c => {
          tbody.innerHTML += `
            <tr class="border-b">
              <td class="py-2 pr-4">${c.name}</td>
              <td class="py-2 pr-4">${convertCategory(c.category)}</td>
              <td class="py-2 pr-4">${c.credits}</td>
            </tr>
          `;
        });
      } catch (e) { console.error(e); }
    }

    function convertCategory(cat) {
      const map = {
        "GE_BASIC": "교양기초",
        "GE_UNIV_REQUIRED": "대학기초필수",
        "GE_UNIV_ELECTIVE": "대학기초선택",
        "EXPLORATION": "탐구",
        "MAJOR_BASIC": "전필",
        "MAJOR_DEEP": "전선"
      };
      return map[cat] || cat;
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadProfile();
      loadCreditSummary();
      loadCourseList();
    });
  </script>

</body>
</html>
