<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Y-CHECK · 마이페이지</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/mypage.css">
</head>

<body>

<header class="site-header">
    <div class="header-inner">
        <div class="header-left">
            <a href="main.html" class="logo-link">
                <img src="../img/ycheck_logo.png" alt="Y-CHECK 로고" class="logo-img">
            </a>
        </div>

        <nav class="main-nav">
            <a href="calculator.html" class="nav-link">계산기</a>
            <a href="timetable.html" class="nav-link">시간표</a>
            <a href="sunbae.html" class="nav-link">선배의 발자취</a>
        </nav>

        <div class="header-right">
            <a href="mypage.html" class="nav-link nav-link-strong">마이페이지</a>
        </div>
    </div>
</header>

<main class="main-container">

    <section class="card">
        <h1 class="page-title">My Page</h1>

        <form class="form-grid">

            <!-- 이름 -->
            <div class="form-group">
                <label class="form-label">이름</label>
                <input id="field-real-name" type="text" class="form-input">
            </div>

            <!-- ID -->
            <div class="form-group">
                <label class="form-label">ID</label>
                <input id="field-username" type="text" class="form-input form-input-disabled" disabled>
            </div>

            <!-- 학번 -->
            <div class="form-group">
                <label class="form-label">학번</label>
                <input id="field-student-id" type="text" class="form-input">
            </div>

            <!-- 학년/학기 -->
            <div class="form-group">
                <label class="form-label">학년/학기</label>
                <select id="field-semester" class="form-input">
                    <option value="">선택하세요</option>
                    <option value="1-1">1학년 1학기</option>
                    <option value="1-2">1학년 2학기</option>
                    <option value="2-1">2학년 1학기</option>
                    <option value="2-2">2학년 2학기</option>
                    <option value="3-1">3학년 1학기</option>
                    <option value="3-2">3학년 2학기</option>
                    <option value="4-1">4학년 1학기</option>
                    <option value="4-2">4학년 2학기</option>
                </select>
            </div>

            <!-- 학과/학부 (새 필드) -->
            <div class="form-group form-group-full">
                <label class="form-label">학과/학부</label>
                <select id="field-major-dept" class="form-input">
                    <option value="">선택하세요</option>
                    <option value="SOFTWARE">소프트웨어학부</option>
                    <option value="DATASCIENCE">데이터사이언스학부</option>
                    <option value="AI_SEMI">AI반도체학부</option>
                    <option value="BIOMED">의공학부</option>
                    <option value="CLINICAL">임상병리학과</option>
                    <option value="OCC_THERAPY">작업치료학과</option>
                </select>
            </div>

            <!-- 관심 분야 -->
            <fieldset class="fieldset form-group-full">
                <legend class="fieldset-legend">관심 전공/분야</legend>

                <div class="checkbox-grid">

                    <label class="checkbox-item">
                        <input type="radio" name="interest" value="AI_ML" class="radio-input">
                        <span>AI/머신러닝</span>
                    </label>

                    <label class="checkbox-item">
                        <input type="radio" name="interest" value="SECURITY_NETWORK" class="radio-input">
                        <span>보안/네트워크</span>
                    </label>

                    <label class="checkbox-item">
                        <input type="radio" name="interest" value="GAME_MEDIA" class="radio-input">
                        <span>게임/미디어</span>
                    </label>

                    <label class="checkbox-item">
                        <input type="radio" name="interest" value="EMBEDDED_SYSTEM" class="radio-input">
                        <span>임베디드/시스템</span>
                    </label>

                    <label class="checkbox-item">
                        <input type="radio" name="interest" value="STARTUP_SERVICE" class="radio-input">
                        <span>창업/서비스 기획</span>
                    </label>

                    <label class="checkbox-item checkbox-item-etc">
                        <input type="radio" name="interest" value="OTHER" class="radio-input">
                        <span>기타</span>
                        <input id="field-interest-etc" type="text"
                               class="form-input form-input-etc"
                               placeholder="예: 로봇, 교육 등">
                    </label>

                </div>
            </fieldset>

            <!-- 데이터 사용 동의 -->
            <div class="form-group form-group-full form-consent">
                <input id="chk-consent" type="checkbox" class="checkbox-input">
                <label for="chk-consent" class="consent-label">데이터 사용 동의</label>
            </div>

            <!-- 버튼 -->
            <div class="form-group form-group-full form-actions">
                <button id="btn-save-profile" type="button" class="btn-primary">
                    정보 수정하기
                </button>
            </div>

        </form>
    </section>
</main>

<footer class="site-footer">
    <div class="footer-inner">
        <div class="footer-left">
            <img src="../img/ycheck_logo.png" alt="Y-CHECK 로고" class="footer-logo" />
            <div class="footer-text">
                <div>강원특별자치도 원주시 흥업면 연세대길 1 창조관</div>
                <div>TEL) 033-123-4567</div>
                <div>EMAIL: YCHECK@gmail.com</div>
            </div>
        </div>
    </div>
</footer>

<script>
    // 마이페이지 불러오기
    async function loadMyPage() {
        try {
            const resp = await fetch("/api/mypage/", {
                method: "GET",
                credentials: "include",
            });

            if (resp.status === 401) {
                alert("로그인이 필요합니다.");
                window.location.href = "login.html";
                return;
            }

            const data = await resp.json();
            const p = data.profile || {};

            document.getElementById("field-username").value       = data.username || "";
            document.getElementById("field-real-name").value      = p.real_name || "";
            document.getElementById("field-student-id").value     = p.student_id || "";
            document.getElementById("field-semester").value       = p.current_semester || "";
            document.getElementById("field-major-dept").value     = p.major_department || "";

            // 관심 분야 설정
            const radios = document.querySelectorAll("input[name='interest']");
            radios.forEach(r => r.checked = (r.value === p.interest));

            document.getElementById("field-interest-etc").value = p.interest_text || "";
            document.getElementById("chk-consent").checked = !!p.data_consent;

        } catch (err) {
            console.error("loadMyPage 오류:", err);
        }
    }

    // 정보 저장
    async function saveMyPage() {
        const selectedRadio = document.querySelector("input[name='interest']:checked");
        const interestValue = selectedRadio ? selectedRadio.value : "";

        const payload = {
            real_name: document.getElementById("field-real-name").value,
            student_id: document.getElementById("field-student-id").value,
            current_semester: document.getElementById("field-semester").value,
            major_department: document.getElementById("field-major-dept").value,
            interest: interestValue,
            interest_text: document.getElementById("field-interest-etc").value,
            data_consent: document.getElementById("chk-consent").checked,
        };

        try {
            const resp = await fetch("/api/mypage/", {
                method: "POST",
                credentials: "include",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload),
            });

            const data = await resp.json();

            if (!data.success) {
                alert("정보 저장 실패");
                return;
            }

            alert("정보가 저장되었습니다!");
            loadMyPage();

        } catch (err) {
            alert("서버 연결 실패");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadMyPage();
        document.getElementById("btn-save-profile").addEventListener("click", saveMyPage);
    });
</script>

</body>
</html>
