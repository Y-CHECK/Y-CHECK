<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Y-CHECK · 마이페이지</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-[#f7f9fc] text-slate-900 pb-24">

  <!-- 공통 헤더 -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="main.html" class="flex items-center gap-3">
          <img src="../img/ycheck_logo.png" alt="Y-CHECK 로고" class="h-8 w-auto">
        </a>
        <div class="h-4 w-px bg-slate-200"></div>
        <div class="text-sm text-slate-600">연세대학교 졸업요건계산기</div>
      </div>
      <nav class="hidden sm:flex items-center gap-6 text-sm text-slate-600">
        <a href="calculator.html" class="hover:text-slate-900">계산기</a>
        <a href="timetable.html" class="hover:text-slate-900">시간표</a>
        <a href="sunbae.html" class="hover:text-slate-900">선배들의 발자취</a>
        <a href="mypage.html" class="hover:text-slate-900 font-semibold">마이페이지</a>
      </nav>
    </div>
  </header>

  <!-- 메인 영역 -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- 왼쪽: 정보 폼 -->
    <section class="lg:col-span-8 bg-white rounded-2xl border shadow-sm p-6">
      <h1 class="text-xl font-semibold mb-6">My Page</h1>

      <form class="grid grid-cols-1 sm:grid-cols-2 gap-5">

        <!-- ID -->
        <div>
          <label class="block text-sm text-slate-600 mb-1">ID</label>
          <input
            id="field-username"
            type="text"
            class="w-full rounded-xl border px-3 py-2 bg-slate-50"
            value=""
            disabled
          >
        </div>

        <!-- 이름 -->
        <div>
          <label class="block text-sm text-slate-600 mb-1">이름</label>
          <input
            id="field-real-name"
            type="text"
            class="w-full rounded-xl border px-3 py-2"
            value=""
          >
        </div>

        <!-- 학번 -->
        <div>
          <label class="block text-sm text-slate-600 mb-1">학번</label>
          <input
            id="field-student-id"
            type="text"
            class="w-full rounded-xl border px-3 py-2"
            value=""
          >
        </div>

        <!-- 이메일 -->
        <div>
          <label class="block text-sm text-slate-600 mb-1">이메일</label>
          <input
            id="field-email"
            type="email"
            class="w-full rounded-xl border px-3 py-2 bg-slate-50"
            value=""
            disabled
          >
        </div>

        <!-- 관심 분야 -->
<fieldset class="sm:col-span-2 border rounded-xl p-4">
  <legend class="px-1 text-sm text-slate-600">관심 전공/분야</legend>
  <div class="grid grid-cols-2 gap-2 text-sm mt-1">
    <label class="inline-flex items-center gap-2">
      <input id="chk-ai" type="checkbox"> AI/머신러닝
    </label>
    <label class="inline-flex items-center gap-2">
      <input id="chk-security" type="checkbox"> 보안/네트워크
    </label>
    <label class="inline-flex items-center gap-2">
      <input id="chk-game" type="checkbox"> 게임/미디어
    </label>
    <label class="inline-flex items-center gap-2">
      <input id="chk-embedded" type="checkbox"> 임베디드/시스템
    </label>
    <label class="inline-flex items-center gap-2">
      <input id="chk-startup" type="checkbox"> 창업/서비스 기획
    </label>
    <label class="inline-flex items-center gap-2 w-full">
      <input id="chk-etc" type="checkbox">
      <span>기타</span>
      <input
        id="field-interest-etc"
        type="text"
        class="flex-1 rounded-lg border px-2 py-1 text-xs"
        placeholder="예: 로봇, 교육 등"
      >
    </label>
  </div>
</fieldset>

        <!-- 데이터 동의 -->
        <div class="sm:col-span-2 flex items-center gap-2">
          <input id="chk-consent" type="checkbox" class="h-4 w-4">
          <span class="text-sm text-slate-700">데이터 사용 동의</span>
        </div>

        <div class="sm:col-span-2 flex justify-end">
          <button id="btn-save-profile"  type="button" class="px-4 py-2 rounded-xl bg-blue-700 text-white text-sm font-semibold">
            정보 수정하기
          </button>
        </div>

      </form>
    </section>

    <!-- 오른쪽: 요약 프로필 -->
    <aside class="lg:col-span-4 space-y-6">

      <div class="bg-white rounded-2xl border shadow-sm p-6">
        <div class="text-sm text-slate-500">프로필</div>
        <div class="mt-2 text-lg font-semibold" id="summary-name">-</div>
        <div class="text-sm text-slate-600" id="summary-basic">-</div>
        <div class="text-sm text-slate-600">소프트웨어학부</div>
      </div>

      <div class="bg-white rounded-2xl border shadow-sm p-6">
        <div class="text-sm text-slate-500">빠른 링크</div>
        <ul class="mt-2 text-sm space-y-1">
          <li><a href="calculator.html" class="text-blue-600 hover:underline">졸업요건 계산기</a></li>
          <li><a href="timetable.html" class="text-blue-600 hover:underline">시간표</a></li>
          <li><a href="sunbae.html" class="text-blue-600 hover:underline">선배들의 발자취</a></li>
        </ul>
      </div>

    </aside>
  </main>

  <!-- 공통 푸터 -->
  <footer class="fixed bottom-0 inset-x-0 bg-white border-t">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-start justify-between">
      <div class="flex items-start gap-4">
        <img src="../img/ycheck_logo.png" alt="Y-CHECK 로고" class="h-6 w-auto" />
        <div class="space-y-1 text-sm text-slate-600 leading-relaxed">
          <div>강원특별자치도 원주시 흥업면 연세대길 1 창조관</div>
          <div>TEL) 033-123-4567</div>
          <div>EMAIL: YCHECK@gmail.com</div>
        </div>
      </div>
      <div class="flex items-center gap-6 text-sm text-slate-600">
        <span class="hidden sm:block h-6 w-px bg-slate-200"></span>
        <span>만든이들</span>
        <span>문의하기</span>
      </div>
    </div>
  </footer>

  <!-- 로그인 확인 + 프로필 정보 가져오기 -->
    <!-- 로그인 확인 + 프로필 정보 가져오기 & 저장하기 -->
  <script>
    async function loadMyPage() {
      const usernameInput   = document.getElementById("field-username");
      const realNameInput   = document.getElementById("field-real-name");
      const studentIdInput  = document.getElementById("field-student-id");
      const emailInput      = document.getElementById("field-email");

      const summaryName     = document.getElementById("summary-name");
      const summaryBasic    = document.getElementById("summary-basic");

      const chkAi       = document.getElementById("chk-ai");
      const chkSecurity = document.getElementById("chk-security");
      const chkGame     = document.getElementById("chk-game");
      const chkEmbedded = document.getElementById("chk-embedded");
      const chkStartup  = document.getElementById("chk-startup");
      const chkEtc      = document.getElementById("chk-etc");
      const chkConsent  = document.getElementById("chk-consent");
      const etcText     = document.getElementById("field-interest-etc");

      try {
        const resp = await fetch("/api/mypage/", {
          method: "GET",
          credentials: "include",
        });

        if (resp.status === 401) {
          alert("로그인이 필요합니다.");
          window.location.href = "login.html";
          return;
        }

        if (!resp.ok) {
          console.error("API 오류:", resp.status);
          return;
        }

        const data = await resp.json();
        if (!data.logged_in) {
          window.location.href = "login.html";
          return;
        }

        const p = data.profile || {};

        // 왼쪽 폼 채우기
        if (usernameInput)  usernameInput.value  = data.username || "";
        if (realNameInput)  realNameInput.value  = p.real_name || "";
        if (studentIdInput) studentIdInput.value = p.student_id || "";
        if (emailInput)     emailInput.value     = data.email || "";

        // 오른쪽 프로필 요약
        if (summaryName) {
          summaryName.textContent = (p.real_name || data.username || "-") + "님";
        }
        if (summaryBasic) {
          const sid = p.student_id || "학번 정보 없음";
          const sem = p.current_semester || "학기 정보 없음";
          summaryBasic.textContent = `${sid} / ${sem}`;
        }

        // 관심 분야(interest) 체크박스 – 문자열 기반 간단 매핑
      const interestStr = (p.interest || "").toString();

      if (chkAi)       chkAi.checked       = interestStr.includes("AI/머신러닝");
      if (chkSecurity) chkSecurity.checked = interestStr.includes("보안/네트워크");
      if (chkGame)     chkGame.checked     = interestStr.includes("게임/미디어");
      if (chkEmbedded) chkEmbedded.checked = interestStr.includes("임베디드/시스템");
      if (chkStartup)  chkStartup.checked  = interestStr.includes("창업/서비스 기획");
      if (chkEtc)      chkEtc.checked      = !!(p.interest_text);  // 기타에 내용 있으면 체크

// 기타 직접 입력
if (etcText) {
  etcText.value = p.interest_text || "";
}
        // 데이터 동의
        if (chkConsent) chkConsent.checked = !!p.data_consent;

      } catch (err) {
        console.error("mypage 오류:", err);
      }
    }

    async function saveMyPage() {
      const realNameInput   = document.getElementById("field-real-name");
      const studentIdInput  = document.getElementById("field-student-id");

      const chkAi       = document.getElementById("chk-ai");
      const chkSecurity = document.getElementById("chk-security");
      const chkGame     = document.getElementById("chk-game");
      const chkEmbedded = document.getElementById("chk-embedded");
      const chkStartup  = document.getElementById("chk-startup");
      const chkEtc      = document.getElementById("chk-etc");
      const chkConsent  = document.getElementById("chk-consent");
      const etcText     = document.getElementById("field-interest-etc");

      // 간단한 값 읽기
      const realName  = realNameInput ? realNameInput.value.trim() : "";
      const studentId = studentIdInput ? studentIdInput.value.trim() : "";

      // 관심 분야(interest) 체크박스 – 문자열 기반 간단 매핑
      // 관심 분야 → 문자열로 묶기
      const interests = [];
      if (chkAi && chkAi.checked)       interests.push("AI/머신러닝");
      if (chkSecurity && chkSecurity.checked) interests.push("보안/네트워크");
      if (chkGame && chkGame.checked)   interests.push("게임/미디어");
      if (chkEmbedded && chkEmbedded.checked) interests.push("임베디드/시스템");
      if (chkStartup && chkStartup.checked)   interests.push("창업/서비스 기획");
      if (chkEtc && chkEtc.checked)     interests.push("기타");

      const payload = {
        real_name: realName,
        student_id: studentId,
        interest: interests.join(","),
        interest_text: etcText ? etcText.value.trim() : "",
        data_consent: chkConsent ? chkConsent.checked : false,
      };

      try {
        const resp = await fetch("/api/mypage/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify(payload),
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok || data.success === false) {
          alert(data.message || "정보 수정에 실패했습니다.");
          console.error("save error", resp.status, data);
          return;
        }

        alert("정보가 저장되었습니다.");
        // 다시 불러와서 요약 카드/폼 동기화
        await loadMyPage();
      } catch (err) {
        console.error("saveMyPage 오류:", err);
        alert("서버에 연결할 수 없습니다.");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadMyPage();

      const btnSave = document.getElementById("btn-save-profile");
      if (btnSave) {
        btnSave.addEventListener("click", saveMyPage);
      }
    });
  </script>

</body>
</html>