<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Y_CHECK · 시간표</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-[#f7f9fc] text-slate-900 pb-24">

<!-- 공통 헤더 -->
<header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">

        <!-- 1. 로고 (좌측) -->
        <div class="flex items-center gap-3">
            <a href="main.html" class="flex items-center gap-3">
                <img src="../img/ycheck_logo.png" alt="Y_CHECK 로고" class="h-8 w-auto">
            </a>
        </div>

        <!-- 2. 내비게이션 -->
        <nav class="hidden sm:flex items-center justify-center flex-1 divide-x divide-slate-300" style="margin-left: 90px;">
            <a href="calculator.html" class="px-6 py-2 text-sm text-slate-600 hover:text-slate-900 font-bold">계산기</a>
            <a href="timetable.html" class="px-6 py-2 text-sm text-slate-900 font-bold">시간표</a>
            <a href="sunbae.html" class="px-6 py-2 text-sm text-slate-600 hover:text-slate-900 font-bold">선배의 발자취</a>
        </nav>

        <!-- 3. 마이페이지 버튼 (우측) -->
        <div class="hidden sm:block">
            <a href="mypage.html" class="px-6 py-2 text-sm text-slate-600 hover:text-slate-900 font-bold">마이페이지</a>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- 메인 시간표 -->
    <section class="lg:col-span-9 bg-white rounded-2xl border shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
            <!-- 🔹 동적으로 바꿀 타이틀 -->
            <h1 id="timetableTitle" class="text-2xl font-bold">시간표</h1>

            <!-- 🔹 학기 선택 드롭다운 (API로 채움) -->
            <select id="semesterSelect" class="rounded-xl border px-3 py-2 text-sm">
                <option value="">학기를 선택하세요</option>
            </select>
        </div>

        <div class="h-px bg-slate-200 mb-4"></div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center">
                <thead>
                <tr class="text-slate-600">
                    <th class="py-2 w-20">교시</th>
                    <th class="py-2">월</th>
                    <th class="py-2">화</th>
                    <th class="py-2">수</th>
                    <th class="py-2">목</th>
                    <th class="py-2">금</th>
                </tr>
                </thead>
                <tbody>
                <tr class="border-t" data-period="1">
                    <td class="py-3 text-slate-500">1교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="1"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="1"></td>
                    <td class="timetable-cell" data-day="WED" data-period="1"></td>
                    <td class="timetable-cell" data-day="THU" data-period="1"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="1"></td>
                </tr>
                <tr class="border-t" data-period="2">
                    <td class="py-3 text-slate-500">2교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="2"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="2"></td>
                    <td class="timetable-cell" data-day="WED" data-period="2"></td>
                    <td class="timetable-cell" data-day="THU" data-period="2"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="2"></td>
                </tr>
                <tr class="border-t" data-period="3">
                    <td class="py-3 text-slate-500">3교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="3"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="3"></td>
                    <td class="timetable-cell" data-day="WED" data-period="3"></td>
                    <td class="timetable-cell" data-day="THU" data-period="3"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="3"></td>
                </tr>
                <tr class="border-t" data-period="4">
                    <td class="py-3 text-slate-500">4교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="4"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="4"></td>
                    <td class="timetable-cell" data-day="WED" data-period="4"></td>
                    <td class="timetable-cell" data-day="THU" data-period="4"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="4"></td>
                </tr>
                <tr class="border-t" data-period="5">
                    <td class="py-3 text-slate-500">5교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="5"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="5"></td>
                    <td class="timetable-cell" data-day="WED" data-period="5"></td>
                    <td class="timetable-cell" data-day="THU" data-period="5"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="5"></td>
                </tr>
                <tr class="border-t" data-period="6">
                    <td class="py-3 text-slate-500">6교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="6"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="6"></td>
                    <td class="timetable-cell" data-day="WED" data-period="6"></td>
                    <td class="timetable-cell" data-day="THU" data-period="6"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="6"></td>
                </tr>
                <tr class="border-t" data-period="7">
                    <td class="py-3 text-slate-500">7교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="7"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="7"></td>
                    <td class="timetable-cell" data-day="WED" data-period="7"></td>
                    <td class="timetable-cell" data-day="THU" data-period="7"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="7"></td>
                </tr>
                <tr class="border-t" data-period="8">
                    <td class="py-3 text-slate-500">8교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="8"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="8"></td>
                    <td class="timetable-cell" data-day="WED" data-period="8"></td>
                    <td class="timetable-cell" data-day="THU" data-period="8"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="8"></td>
                </tr>
                <tr class="border-t" data-period="9">
                    <td class="py-3 text-slate-500">9교시</td>
                    <td class="timetable-cell" data-day="MON" data-period="9"></td>
                    <td class="timetable-cell" data-day="TUE" data-period="9"></td>
                    <td class="timetable-cell" data-day="WED" data-period="9"></td>
                    <td class="timetable-cell" data-day="THU" data-period="9"></td>
                    <td class="timetable-cell" data-day="FRI" data-period="9"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- 오른쪽: 컨트롤 / 담은 수업 / 시간표 공유 -->
    <aside class="lg:col-span-3 space-y-4">
        <!-- 상단 컨트롤 -->
        <div class="bg-white rounded-2xl border shadow-sm p-4 space-y-3">
            <button id="openSearchModalButton"
                    class="w-full text-left border rounded-xl px-3 py-2 text-sm">
                + 수업 목록에서 검색해서 추가하기
            </button>
            <button id="openNewTimetableModalButton"
                    class="w-full text-left border rounded-xl px-3 py-2 text-sm">
                + 새 시간표 만들기
            </button>
        </div>

        <!-- 담은 수업 박스 (위) -->
        <div class="bg-white rounded-2xl border shadow-sm p-5">
            <div class="text-lg font-semibold mb-2">담은 수업</div>
            <div class="h-px bg-slate-200 mb-3"></div>
            <ul class="space-y-2 text-sm">
                <li class="flex items-center justify-between">
                    <span class="font-medium">데이터구조론</span>
                    <span class="text-slate-500">월3, 수4</span>
                </li>
                <!-- TODO: 나중에 실제 담은 수업 데이터로 교체 가능 -->
            </ul>
        </div>

        <!-- 선배의 발자취에 시간표 공유 (체크박스 방식) -->
        <div class="bg-white rounded-2xl border shadow-sm p-5">
            <div class="text-lg font-semibold mb-2">선배의 발자취에 시간표 공유</div>
            <div class="h-px bg-slate-200 mb-3"></div>

            <!-- 체크 UI -->
            <label class="flex items-center gap-3 text-sm cursor-pointer select-none">
                <input
                        id="chk-share-timetable"
                        type="checkbox"
                        class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                />
                <span class="font-medium text-slate-800">내 시간표 공유하기</span>
            </label>

            <p class="mt-2 text-xs text-slate-500">
                체크하면 내 시간표가 후배들에게 공개됩니다.
            </p>
        </div>
    </aside>
</main>

<!-- ==== 공통 푸터 + 모달 + 스크립트 ==== -->
<footer class="absolute bottom-0 inset-x-0 bg-white border-t w-full">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-start justify-between">
        <div class="flex items-start gap-4">
            <div class="space-y-0.5 text-sm text-slate-600 leading-tight">
                <div>Inc: 강원특별자치도 원주시 흥업면 연세대길 1</div>
                <div>Tel: 033-123-4567</div>
                <div>Email: YCHECK@gmail.com</div>
            </div>
        </div>
        <div class="flex items-center gap-6 text-sm text-slate-600 leading-tight" style="margin-top: 12px;">
            <span class="hidden sm:block h-6 w-px bg-slate-200"></span>
            <a href="#" class="text-xs text-blak-600 hover:underline" id="open-makers-modal"><span>만든이들</span></a>
            <a href="#" class="text-xs text-black-600 hover:underline" id="open-contact-modal"><span>문의하기</span></a>
        </div>
    </div>
</footer>

<!-- 만든이들 모달 -->
<div id="makers-modal-overlay"
     class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-2xl px-6 py-8 w-full max-w-md shadow-xl relative">
        <button id="close-makers-modal"
                class="absolute top-3 right-3 text-slate-500 hover:text-slate-700 text-2xl font-bold"
                aria-label="닫기">&times;</button>
        <h2 class="text-xl font-bold mb-4 text-center">만든이들</h2>
        <div class="space-y-2 text-sm text-slate-700">
            <div><strong>홍길동</strong> – 프론트엔드 개발, UI/UX 디자인</div>
            <div><strong>김영희</strong> – 백엔드 개발, DB 설계</div>
            <div><strong>박철수</strong> – 기획, 문서화, QA</div>
            <hr class="my-2">
            <div class="text-xs text-slate-500">
                Y_CHECK 서비스는 위 팀원이 함께 만들었습니다.<br>
                궁금한 점은 언제든 문의해 주세요!
            </div>
        </div>
    </div>
</div>

<!-- 문의하기 모달 -->
<div id="contact-modal-overlay"
     class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-2xl px-6 py-8 w-full max-w-md shadow-xl relative">
        <button id="close-contact-modal"
                class="absolute top-3 right-3 text-slate-500 hover:text-slate-700 text-2xl font-bold"
                aria-label="닫기">&times;</button>
        <h2 class="text-xl font-bold mb-5 text-center">문의하기</h2>
        <form class="space-y-4" id="contact-form" autocomplete="off">
            <div>
                <label for="inquiry-type" class="block text-sm mb-1 font-medium text-slate-700">문의 유형</label>
                <select id="inquiry-type" name="inquiry-type" class="w-full rounded-xl border px-3 py-2 text-sm">
                    <option value="" selected disabled>문의 유형을 선택하세요</option>
                    <option value="계정">계정 관련</option>
                    <option value="불편">이용 불편</option>
                    <option value="건의">기능 건의</option>
                    <option value="오류">버그/오류 신고</option>
                    <option value="기타">기타(직접입력)</option>
                </select>
            </div>
            <div id="custom-type-wrap" class="hidden">
                <input type="text" id="custom-type"
                       class="w-full rounded-xl border px-3 py-2 text-sm mt-2"
                       placeholder="문의 종류를 입력하세요">
            </div>
            <div>
                <label for="inquiry-content" class="block text-sm mb-1 font-medium text-slate-700">문의 내용</label>
                <textarea id="inquiry-content" name="inquiry-content"
                          rows="4"
                          class="w-full rounded-xl border px-3 py-2 text-sm resize-none"
                          placeholder="문의하실 내용을 입력해 주세요."
                          required></textarea>
            </div>
            <button type="submit"
                    class="w-full rounded-xl bg-blue-700 text-white py-2 text-sm font-semibold mt-2">
                문의 접수하기
            </button>
        </form>
        <div id="contact-success" class="hidden mt-4 text-green-600 text-sm text-center font-semibold">
            문의가 정상적으로 접수되었습니다.
        </div>
    </div>
</div>

<!-- 팝업 오버레이 (수업 목록 검색) -->
<div id="searchModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-lg font-bold">수업 목록 검색</h3>
            <button id="closeSearchModal" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
        </div>
        <p class="text-slate-700">여기에 수업 검색 내용이 들어갈 것입니다.</p>
    </div>
</div>

<!-- 팝업 오버레이 (새 시간표) -->
<div id="newTimetableModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-lg font-bold">새 시간표</h3>
            <button id="closeNewTimetableModal" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
        </div>
        <div class="space-y-4">
            <div class="flex items-center justify-center text-xl font-bold">
                <div class="flex items-center">
                    <input type="number" id="yearInput" value="2025" min="1900" max="2100" class="w-20 text-center border-none focus:ring-0 text-xl font-bold" />
                </div>
                <span class="mx-2">년</span>
                <div class="flex items-center">
                    <input type="number" id="semesterInput" value="2" min="1" max="2" class="w-12 text-center border-none focus:ring-0 text-xl font-bold" />
                </div>
                <span class="ml-2">학기</span>
            </div>
            <div class="flex justify-center mt-4">
                <button id="createTimetableButton" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">시간표 생성</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 만든이들 모달
    const openMakersBtn = document.getElementById('open-makers-modal');
    const makersModal = document.getElementById('makers-modal-overlay');
    const closeMakersBtn = document.getElementById('close-makers-modal');
    if (openMakersBtn && makersModal && closeMakersBtn) {
        openMakersBtn.addEventListener('click', function(e) {
            e.preventDefault();
            makersModal.classList.remove('hidden');
        });
        closeMakersBtn.addEventListener('click', function() {
            makersModal.classList.add('hidden');
        });
        makersModal.addEventListener('click', function(e) {
            if (e.target === makersModal) makersModal.classList.add('hidden');
        });
        document.addEventListener('keydown', function(e) {
            if (!makersModal.classList.contains('hidden') && e.key === 'Escape')
                makersModal.classList.add('hidden');
        });
    }

    // 문의하기 모달
    const openContactBtn = document.getElementById('open-contact-modal');
    const contactModal = document.getElementById('contact-modal-overlay');
    const closeContactBtn = document.getElementById('close-contact-modal');
    if (openContactBtn && contactModal && closeContactBtn) {
        openContactBtn.addEventListener('click', function(e) {
            e.preventDefault();
            contactModal.classList.remove('hidden');
        });
        closeContactBtn.addEventListener('click', function() {
            contactModal.classList.add('hidden');
        });
        contactModal.addEventListener('click', function(e) {
            if (e.target === contactModal) contactModal.classList.add('hidden');
        });
        document.addEventListener('keydown', function(e) {
            if (!contactModal.classList.contains('hidden') && e.key === 'Escape')
                contactModal.classList.add('hidden');
        });

        // 문의 종류 기타 입력
        const inquiryType = document.getElementById('inquiry-type');
        const customTypeWrap = document.getElementById('custom-type-wrap');
        const customTypeInput = document.getElementById('custom-type');
        if (inquiryType && customTypeWrap && customTypeInput) {
            inquiryType.addEventListener('change', function () {
                if (this.value === '기타') {
                    customTypeWrap.classList.remove('hidden');
                    customTypeInput.setAttribute('required', 'required');
                } else {
                    customTypeWrap.classList.add('hidden');
                    customTypeInput.value = '';
                    customTypeInput.removeAttribute('required');
                }
            });
        }

        // 문의폼 제출 처리(예시)
        const contactForm = document.getElementById('contact-form');
        const contactSuccess = document.getElementById('contact-success');
        const customTypeWrap2 = document.getElementById('custom-type-wrap');
        if (contactForm && contactSuccess) {
            contactForm.addEventListener('submit', function(e) {
                e.preventDefault();
                contactForm.classList.add('hidden');
                contactSuccess.classList.remove('hidden');
                setTimeout(() => {
                    contactModal.classList.add('hidden');
                    contactForm.reset();
                    contactForm.classList.remove('hidden');
                    customTypeWrap2.classList.add('hidden');
                    contactSuccess.classList.add('hidden');
                }, 1800);
            });
        }
    }

    // 오른쪽 상단 컨트롤 모달
    const openSearchModalButton = document.getElementById('openSearchModalButton');
    const openNewTimetableModalButton = document.getElementById('openNewTimetableModalButton');

    const searchModalOverlay = document.getElementById('searchModalOverlay');
    const closeSearchModalButton = document.getElementById('closeSearchModal');

    const newTimetableModalOverlay = document.getElementById('newTimetableModalOverlay');
    const closeNewTimetableModalButton = document.getElementById('closeNewTimetableModal');

    const createTimetableButton = document.getElementById('createTimetableButton');
    const yearInput = document.getElementById('yearInput');
    const semesterInput = document.getElementById('semesterInput');

    if (openSearchModalButton && searchModalOverlay && closeSearchModalButton) {
        openSearchModalButton.addEventListener('click', () => {
            searchModalOverlay.classList.remove('hidden');
            searchModalOverlay.classList.add('flex');
        });
        closeSearchModalButton.addEventListener('click', () => {
            searchModalOverlay.classList.add('hidden');
            searchModalOverlay.classList.remove('flex');
        });
    }

    if (openNewTimetableModalButton && newTimetableModalOverlay && closeNewTimetableModalButton) {
        openNewTimetableModalButton.addEventListener('click', () => {
            newTimetableModalOverlay.classList.remove('hidden');
            newTimetableModalOverlay.classList.add('flex');
        });
        closeNewTimetableModalButton.addEventListener('click', () => {
            newTimetableModalOverlay.classList.add('hidden');
            newTimetableModalOverlay.classList.remove('flex');
        });
    }

    // ✅ 시간표 공유 체크 상태 저장/복원 (로컬 예시)
    const SHARE_KEY = "ycheck-share-timetable";
    const shareChk = document.getElementById("chk-share-timetable");
    if (shareChk) {
        // 복원
        shareChk.checked = (localStorage.getItem(SHARE_KEY) === "true");

        shareChk.addEventListener("change", () => {
            localStorage.setItem(SHARE_KEY, String(shareChk.checked));
            if (shareChk.checked) {
                alert("시간표 공유가 ON 되었습니다! (예시)");
            } else {
                alert("시간표 공유가 OFF 되었습니다! (예시)");
            }
        });
    }

    // ================================
    //   시간표 API 연동 부분
    //   /api/timetable/semesters/
    //   /api/timetable/?year=YYYY&semester=S
    // ================================
    const timetableTitle = document.getElementById("timetableTitle");
    const semesterSelect = document.getElementById("semesterSelect");

    let currentYear = null;
    let currentSemester = null;

    function formatSemesterLabel(year, semester) {
        return `${year}년 ${semester}학기`;
    }

    function clearTimetableCells() {
        document.querySelectorAll('.timetable-cell').forEach(td => {
            td.innerHTML = '';
        });
    }

    // 🔹 학기 목록 가져오기
    async function fetchSemesters() {
        try {
            const res = await fetch("/api/timetable/semesters/", {
                method: "GET",
                credentials: "include",
            });

            if (!res.ok) {
                console.error("학기 목록 불러오기 실패:", res.status, res.statusText);
                return [];
            }

            const data = await res.json();

            // 서버가 배열로 주든, {semesters: [...]} 로 주든 둘 다 처리
            if (Array.isArray(data)) {
                return data;
            }
            if (data && Array.isArray(data.semesters)) {
                return data.semesters;
            }
            return [];
        } catch (err) {
            console.error("학기 목록 로딩 중 오류:", err);
            return [];
        }
    }

    // 🔹 특정 연도/학기 시간표 로딩
    async function loadTimetable(year, semester) {
        if (!year || !semester) {
            clearTimetableCells();
            timetableTitle.textContent = "시간표";
            return;
        }

        currentYear = year;
        currentSemester = semester;
        timetableTitle.textContent = formatSemesterLabel(year, semester);

        try {
            const res = await fetch(`/api/timetable/?year=${year}&semester=${semester}`, {
                method: "GET",
                credentials: "include",
            });

            clearTimetableCells();

            if (res.status === 404) {
                console.log("해당 학기 시간표 없음");
                return;
            }

            if (!res.ok) {
                console.error("시간표 불러오기 실패:", res.status, res.statusText);
                return;
            }

            const data = await res.json();

            // 서버가 배열로 주든, {timetable: [...]} 로 주든 둘 다 처리
            const entries = Array.isArray(data) ? data : (data.timetable || []);

            entries.forEach(item => {
                const selector = `.timetable-cell[data-day="${item.day}"][data-period="${item.period}"]`;
                const cell = document.querySelector(selector);
                if (!cell) return;

                const subject = item.subject || '';
                const classroom = item.classroom || '';
                const memo = item.memo || '';

                cell.innerHTML = `
                    <div class="font-medium text-xs sm:text-sm">${subject}</div>
                    <div class="text-[10px] sm:text-xs text-slate-500">
                        ${classroom ? classroom : ''}${memo ? (classroom ? ' · ' : '') + memo : ''}
                    </div>
                `;
            });
        } catch (err) {
            console.error("시간표 로딩 중 오류:", err);
        }
    }

    // 🔹 학기 셀렉트 초기화
    async function initSemesterSelect() {
        const semesters = await fetchSemesters();

        // 기존 옵션 제거 후 기본값 하나만 남기기
        semesterSelect.innerHTML = '<option value="">학기를 선택하세요</option>';

        semesters.forEach(({ year, semester, label }) => {
            const opt = document.createElement("option");
            opt.value = `${year}-${semester}`;
            opt.dataset.year = year;
            opt.dataset.semester = semester;
            opt.textContent = label || formatSemesterLabel(year, semester);
            semesterSelect.appendChild(opt);
        });

        if (semesters.length > 0) {
            // 최근 학기(가장 첫 번째 or 마지막, 백엔드 정렬 기준에 따라 선택)
            const first = semesters[0];
            const val = `${first.year}-${first.semester}`;
            semesterSelect.value = val;
            await loadTimetable(first.year, first.semester);
        } else {
            clearTimetableCells();
            timetableTitle.textContent = "시간표";
        }

        semesterSelect.addEventListener("change", async (e) => {
            const value = e.target.value;
            if (!value) {
                clearTimetableCells();
                timetableTitle.textContent = "시간표";
                return;
            }
            const [y, s] = value.split("-");
            const year = parseInt(y, 10);
            const semester = parseInt(s, 10);
            await loadTimetable(year, semester);
        });
    }

    // 새 시간표 생성 버튼 (백엔드 POST /api/timetable/ 는 나중에 구현)
    if (createTimetableButton && newTimetableModalOverlay && yearInput && semesterInput) {
        createTimetableButton.addEventListener('click', async () => {
            const year = parseInt(yearInput.value, 10);
            const semester = parseInt(semesterInput.value, 10);

            newTimetableModalOverlay.classList.add('hidden');
            newTimetableModalOverlay.classList.remove('flex');

            try {
                const res = await fetch("/api/timetable/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    credentials: "include",
                    body: JSON.stringify({
                        year: year,
                        semester: semester,
                        timetable: [],
                    }),
                });

                if (!res.ok) {
                    console.error("새 시간표 생성 실패:", res.status, res.statusText);
                    alert("시간표 생성에 실패했습니다.");
                    return;
                }

                const value = `${year}-${semester}`;
                let option = Array.from(semesterSelect.options).find(opt => opt.value === value);
                if (!option) {
                    option = document.createElement("option");
                    option.value = value;
                    option.dataset.year = year;
                    option.dataset.semester = semester;
                    option.textContent = formatSemesterLabel(year, semester);
                    semesterSelect.appendChild(option);
                }

                semesterSelect.value = value;
                await loadTimetable(year, semester);
            } catch (err) {
                console.error("새 시간표 생성 중 오류:", err);
                alert("시간표 생성 중 오류가 발생했습니다.");
            }
        });
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', () => {
        initSemesterSelect();
    });
</script>

</body>
</html>
